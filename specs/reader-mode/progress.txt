## 2026-01-17: Spec Creation

**Files created:**
- `specs/reader-mode/instructions.md`
- `specs/reader-mode/requirements.md`
- `specs/reader-mode/design.md`
- `specs/reader-mode/plan.md`
- `specs/reader-mode/prd.json`
- `specs/README.md` (updated with reader-mode entry)

**Key decisions:**
- Extend existing WebPageParser DO (not create new DO)
- Use `@mozilla/readability` + `linkedom/worker` for content extraction
- Keep `fetchlog` and `reader_content` as separate tables (simpler, no migration)
- Images proxied via `/api/proxy-image?url=...` to avoid CORS/tracking
- Same 24h cache TTL as existing metadata
- Tests integrated into each implementation task (not separate final step)

**Architecture:**
- New RPC: `getReaderContent({ forceFetch?: boolean })` → `ReaderResult`
- New table: `reader_content` with extracted article data
- New route: `GET /api/proxy-image?url=<encoded>` for image proxying
- New files: `fetchReaderContent.ts`, `proxyImage.ts`

**Requirements summary:**
- 15 functional requirements (FR-1 to FR-5)
- 11 non-functional requirements (NFR-1 to NFR-4)
- 7 acceptance tests

## 2026-01-18: Task 1 - Dependencies

**Completed:**
- Added `linkedom` and `@mozilla/readability` to worker dependencies
- Added `@types/mozilla__readability` to worker devDependencies
- All packages use workspace catalog versions

**Verification:**
- `pnpm install` ✓
- `turbo run typecheck` ✓
- Packages in `apps/worker/package.json` ✓

## 2026-01-18: Task 2 - Schema

**Files changed:**
- `packages/web-page-parser/src/schema.ts` - added ReaderContent, ReaderResult
- `packages/web-page-parser/src/index.ts` - export new types

**Verification:**
- `turbo run typecheck` ✓

## 2026-01-18: Task 3 - TaggedErrors

**Files changed:**
- `packages/web-page-parser/src/errors.ts` - new file with 6 TaggedErrors
- `packages/web-page-parser/src/index.ts` - export all errors

**Errors added:**
- FetchTimeoutError, FetchHttpError, FetchNetworkError
- NotReadableError, ParseError, InvalidProtocolError

**Verification:**
- `turbo run typecheck` ✓

## 2026-01-18: Task 4 - RPC Definition

**Files changed:**
- `packages/web-page-parser/src/rpc.ts` - added getReaderContent RPC
- `apps/worker/src/features/web-page-parser/handlers.ts` - added stub handler

**Key decisions:**
- Added stub handler returning `{readable: false, content: null, error: "Not implemented"}` for typecheck to pass
- Spellbook.make requires all RPC handlers to be present

**Verification:**
- `turbo run typecheck` ✓
- `pnpm --filter worker run test` ✓

## 2026-01-18: Task 5 - Database Schema

**Files changed:**
- `apps/worker/src/features/web-page-parser/drizzle/drizzle.schema.ts` - added readerContent table
- `apps/worker/src/features/web-page-parser/drizzle/migrations/0001_orange_marvel_boy.sql` - migration created
- `apps/worker/src/features/web-page-parser/drizzle/migrations/migrations.js` - auto-updated

**Notes:**
- drizzle-kit requires explicit `--config` path for per-feature configs

**Verification:**
- `turbo run typecheck` ✓
- `pnpm --filter worker run test` ✓
- Migration SQL contains CREATE TABLE reader_content ✓

## 2026-01-18: Task 6 - fetchReaderContent Implementation

**Files changed:**
- `apps/worker/src/features/web-page-parser/fetchReaderContent.ts` - new file
- `apps/worker/test/fetchReaderContent.spec.ts` - new file with 13 tests
- `apps/worker/package.json` - removed @types/mozilla__readability (package has own types)

**Implementation:**
- Use HttpClient from @effect/platform with filterStatusOk
- HttpClientRequest.get with User-Agent and Accept headers
- Effect.timeout(Duration.seconds(15)) for timeout handling
- Map HttpClient errors to domain TaggedErrors using Effect.catchTag
- Parse HTML with linkedom/worker parseHTML
- Use isProbablyReaderable check before extraction
- Extract with Readability, validate required fields
- rewriteImageUrls converts relative URLs to proxy URLs
- calculateReadingStats at 200 wpm rate

**Tests (13 total):**
- URL validation: InvalidProtocolError for file://, javascript://
- URL validation: accepts http://, https://
- HTTP errors: FetchHttpError for 404/500
- HTTP errors: FetchNetworkError for network failures
- Readability: NotReadableError for non-article pages
- Extraction: extracts title, content, textContent, wordCount, readingTime
- Extraction: rewrites image URLs to proxy
- Extraction: calculates word count correctly
- Extraction: calculates reading time at 200 wpm
- Optional fields: handles missing byline gracefully

**Key decisions:**
- Removed @types/mozilla__readability - package has built-in types
- Check article.title, content, textContent before building result
- Use ?? null for optional fields (excerpt, byline, siteName)

**Verification:**
- `turbo run typecheck` ✓
- `pnpm --filter worker run test fetchReaderContent` ✓ (13 tests passing)

## 2026-01-18: Task 7 - proxyImage Implementation

**Files created:**
- `apps/worker/src/features/web-page-parser/proxyImage.ts`
- `apps/worker/test/proxyImage.spec.ts`

**Implementation:**
- Use HttpClient from @effect/platform with filterStatusOk
- HttpClientRequest.get with User-Agent header
- Effect.timeout(Duration.seconds(10)) for timeout
- Map HttpClient errors to domain TaggedErrors
- Use response.arrayBuffer to get body (not stream - Effect Stream incompatible with web Response)
- Return Response with Cache-Control: public, max-age=86400 (24h)
- Preserve Content-Type from upstream, default to image/png

**Tests (11 total):**
- URL validation: InvalidProtocolError for file://, data://
- URL validation: accepts http://, https://
- HTTP errors: FetchHttpError for 404/500
- HTTP errors: FetchNetworkError for network failures
- Success: returns Cache-Control header
- Success: preserves Content-Type from upstream
- Success: defaults to image/png when Content-Type missing
- Success: streams response body correctly

**Key decisions:**
- Used response.arrayBuffer instead of response.stream (Effect Stream not BodyInit-compatible)
- 10s timeout (shorter than 15s for content - images should be faster)

**Verification:**
- `turbo run typecheck` ✓
- `pnpm --filter worker run test` ✓ (106 tests passing)
