{
  "feature": "reader-mode",
  "description": "Instapaper-like clean content extraction for web pages",
  "tasks": [
    {
      "id": "1",
      "category": "dependencies",
      "description": "Add linkedom and @mozilla/readability packages",
      "steps": [
        "Run: pnpm --filter worker add linkedom @mozilla/readability",
        "Verify packages in apps/worker/package.json (Note: @types/mozilla__readability not needed, package has own types)"
      ],
      "verification": [
        "pnpm install completes without errors",
        "packages listed in package.json dependencies"
      ],
      "passes": true
    },
    {
      "id": "2",
      "category": "schema",
      "description": "Add ReaderContent and ReaderResult Effect schemas",
      "steps": [
        "Edit packages/web-page-parser/src/schema.ts",
        "Add ReaderContent schema with: title, content, textContent, excerpt, byline, siteName, wordCount, readingTimeMinutes",
        "Add ReaderResult schema with: readable, content, error",
        "Export types"
      ],
      "verification": [
        "turbo run typecheck passes"
      ],
      "passes": true
    },
    {
      "id": "3",
      "category": "errors",
      "description": "Add TaggedErrors for fetch and parse failures",
      "steps": [
        "Create packages/web-page-parser/src/errors.ts",
        "Add FetchTimeoutError with url field",
        "Add FetchHttpError with url and status fields",
        "Add FetchNetworkError with url and message fields",
        "Add NotReadableError with url field",
        "Add ParseError with url and message fields",
        "Add InvalidProtocolError with url and protocol fields",
        "Use Schema.TaggedError pattern from @kampus/library"
      ],
      "verification": [
        "turbo run typecheck passes",
        "errors importable from @kampus/web-page-parser"
      ],
      "passes": true
    },
    {
      "id": "4",
      "category": "rpc",
      "description": "Add getReaderContent RPC definition and export types",
      "steps": [
        "Edit packages/web-page-parser/src/rpc.ts",
        "Add getReaderContent RPC with payload { forceFetch?: boolean }",
        "Set success type to ReaderResult",
        "Edit packages/web-page-parser/src/index.ts",
        "Export ReaderContent, ReaderResult types and all errors",
        "Add stub handler in handlers.ts for typecheck to pass"
      ],
      "verification": [
        "turbo run typecheck passes",
        "types and errors importable from @kampus/web-page-parser"
      ],
      "passes": true
    },
    {
      "id": "5",
      "category": "database",
      "description": "Add readerContent table and generate migration",
      "steps": [
        "Edit apps/worker/src/features/web-page-parser/drizzle/drizzle.schema.ts",
        "Add readerContent table with columns: id, readable, title, content, textContent, excerpt, byline, siteName, wordCount, readingTimeMinutes, error, createdAt",
        "Run: cd apps/worker && pnpm exec drizzle-kit generate --config=./src/features/web-page-parser/drizzle/drizzle.config.ts",
        "Verify migration file created"
      ],
      "verification": [
        "turbo run typecheck passes",
        "migration SQL file exists with CREATE TABLE reader_content"
      ],
      "passes": true
    },
    {
      "id": "6",
      "category": "implementation",
      "description": "Create fetchReaderContent.ts with Effect + HttpClient",
      "steps": [
        "Create apps/worker/src/features/web-page-parser/fetchReaderContent.ts",
        "Use HttpClient from @effect/platform for fetch",
        "Use HttpClientRequest.get with custom headers",
        "Apply Effect.timeout with Duration.seconds(15)",
        "Map HttpClient errors to domain TaggedErrors using Effect.catchTag",
        "Parse HTML with linkedom/worker",
        "Extract content with Readability",
        "Implement rewriteImageUrls to proxy images",
        "Calculate wordCount and readingTimeMinutes",
        "Return Effect<ReaderContent, ...errors, HttpClient>",
        "Add tests in apps/worker/test/fetchReaderContent.spec.ts",
        "Test: successful extraction from article HTML",
        "Test: returns NotReadableError for non-article HTML",
        "Test: image URLs are rewritten to proxy",
        "Test: word count and reading time calculation",
        "Test: FetchTimeoutError on timeout",
        "Test: FetchHttpError on 404/500",
        "Test: InvalidProtocolError on file:// URL"
      ],
      "verification": [
        "turbo run typecheck passes",
        "pnpm --filter worker run test passes",
        "fetchReaderContent tests cover happy path and all error types"
      ],
      "passes": true
    },
    {
      "id": "7",
      "category": "implementation",
      "description": "Create proxyImage.ts with Effect + HttpClient",
      "steps": [
        "Create apps/worker/src/features/web-page-parser/proxyImage.ts",
        "Use HttpClient from @effect/platform",
        "Use HttpClientRequest.get with User-Agent header",
        "Apply Effect.timeout with Duration.seconds(10)",
        "Map HttpClient errors to domain TaggedErrors using Effect.catchTag",
        "Return Effect<Response, ...errors, HttpClient>",
        "Stream response body with Cache-Control header",
        "Add tests in apps/worker/test/proxyImage.spec.ts",
        "Test: InvalidProtocolError on file:// URL",
        "Test: FetchTimeoutError on timeout",
        "Test: FetchHttpError on 404/500",
        "Test: returns correct cache headers on success"
      ],
      "verification": [
        "turbo run typecheck passes",
        "pnpm --filter worker run test passes",
        "proxyImage tests cover all error types"
      ],
      "passes": true
    },
    {
      "id": "8",
      "category": "implementation",
      "description": "Add getReaderContent handler with tests",
      "steps": [
        "Edit apps/worker/src/features/web-page-parser/handlers.ts",
        "Import fetchReaderContent and readerContent schema",
        "Add getReaderContent handler using Effect.gen",
        "Check cache with 24h TTL",
        "Fetch if cache miss or forceFetch",
        "Convert TaggedErrors to ReaderResult using Match.value + Match.tag",
        "Provide FetchHttpClient.layer",
        "Store result (including error state) in database",
        "Add tests in apps/worker/test/web-page-parser-handlers.spec.ts",
        "Test: returns cached data when recent",
        "Test: forceFetch bypasses cache",
        "Test: stores and returns error state for non-readable pages"
      ],
      "verification": [
        "turbo run typecheck passes",
        "pnpm --filter worker run test passes",
        "handler tests cover cache behavior and error conversion"
      ],
      "passes": false
    },
    {
      "id": "9",
      "category": "routing",
      "description": "Add /api/proxy-image route with Effect error handling",
      "steps": [
        "Edit apps/worker/src/index.ts",
        "Import proxyImage, FetchHttpClient, Effect, Match",
        "Add GET /api/proxy-image route",
        "Return 400 if url param missing",
        "Run proxyImage Effect with Effect.runPromise",
        "Convert TaggedErrors to HTTP responses using Match.value + Match.tag",
        "Provide FetchHttpClient.layer",
        "Add integration test in apps/worker/test/proxy-image-route.spec.ts",
        "Test: returns 400 for missing url param",
        "Test: returns 400 for invalid protocol",
        "Test: returns 504 for timeout",
        "Test: proxies valid image URL with cache headers"
      ],
      "verification": [
        "turbo run typecheck passes",
        "pnpm --filter worker run test passes",
        "route tests cover param validation and error responses"
      ],
      "passes": false
    },
    {
      "id": "10",
      "category": "verification",
      "description": "Final verification",
      "steps": [
        "Run: turbo run typecheck",
        "Run: turbo run lint",
        "Run: pnpm --filter worker run test",
        "Manual: test getReaderContent on real article URL",
        "Manual: verify images load through proxy"
      ],
      "verification": [
        "all checks pass",
        "reader content extracts correctly",
        "images display via proxy"
      ],
      "passes": false
    }
  ]
}
