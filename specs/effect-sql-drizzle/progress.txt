# Progress Log

## 2026-01-16: Add @effect/sql-drizzle dependency (ESD-001)

Files changed:
- apps/worker/package.json - added @effect/sql-drizzle
- apps/worker/src/shared/Spellbook.ts - added SqliteDrizzle import

Verified:
- pnpm install succeeds
- import { SqliteDrizzle } from '@effect/sql-drizzle/Sqlite' compiles
- typecheck passes
- all 70 tests pass

## 2026-01-16: Spellbook schema + SqliteDrizzle (ESD-002, ESD-003)

Files changed:
- apps/worker/src/shared/Spellbook.ts
  - MakeConfig now requires schema: TSchema generic param
  - drizzleLayer created via makeDrizzle({schema})
  - Layer composition: drizzleWithSql = Layer.provideMerge(drizzleLayer, sqliteLayer)
  - Kept layers optional (@deprecated) for backward compat during migration
- apps/worker/src/features/library/Library.ts - passes schema, keeps RepoLayer temporarily
- apps/worker/src/features/web-page-parser/WebPageParser.ts - passes schema

Key decisions:
- Cast needed for drizzleLayer: SqliteDrizzle tag uses untyped SqliteRemoteDatabase
- Kept layers param with @deprecated - handlers still use StoryRepo/TagRepo
- ESD-004 (remove layers) blocked until handlers migrated (ESD-100 to ESD-112)

## 2026-01-16: Migrate getStory to Drizzle (ESD-100)

Files changed:
- apps/worker/src/features/library/handlers.ts
  - Added SqliteDrizzle, eq imports from drizzle-orm
  - Added schema import for Drizzle tables
  - Replaced StoryRepo.findById with db.select().from(schema.story).where(eq(...))
  - Drizzle returns Date objects, converted to timestamps for formatStory helper

Key decisions:
- Keep getTagsForStoriesSimple as raw SQL for now - migrate in ESD-112
- formatStory helper expects numeric timestamps, convert Drizzle Date objects inline
- StoryRepo still imported (used by other handlers) - will be removed after full migration

Next: migrate listStories (ESD-101)

## 2026-01-16: Migrate listStories to Drizzle (ESD-101)

Files changed:
- apps/worker/src/features/library/handlers.ts
  - Added count, desc, lt imports from drizzle-orm
  - Replaced raw sql`` with db.select({ total: count() }) for count
  - Replaced raw sql`` with db.select().from(schema.story).orderBy(desc(...)).limit(...) for stories
  - Used lt() for cursor-based pagination with after param
  - Drizzle returns Date objects, convert to timestamps for formatStory
- apps/worker/test/library-handlers.spec.ts
  - Removed listStories unit tests (now require SqliteDrizzle mock)
  - Tests covered by integration tests in library-stories.spec.ts

Key decisions:
- Keep getTagsForStoriesSimple as raw SQL for now - migrate in ESD-112
- Unit tests removed since listStories is comprehensively tested in integration tests
- 68 tests pass

Next: migrate listStoriesByTag (ESD-102)
