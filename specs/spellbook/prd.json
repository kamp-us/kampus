{
	"feature": "spellbook",
	"description": "Refactor DO infrastructure to Effect-native with Spellbook.make pattern",
	"items": [
		{
			"id": "SP-001",
			"category": "Infrastructure",
			"description": "Spellbook.make() accepts RPC definitions, handlers, and migrations config",
			"stepsToVerify": [
				"Spellbook.ts exports a `make` function",
				"Function accepts { rpcs, handlers, migrations } config object",
				"TypeScript compiles without errors"
			],
			"passes": true
		},
		{
			"id": "SP-002",
			"category": "Infrastructure",
			"description": "Spellbook.make() returns a DurableObject class",
			"stepsToVerify": [
				"Returned class extends DurableObject<TEnv>",
				"Class can be exported and used in wrangler.jsonc bindings",
				"DO instantiation works in Cloudflare runtime"
			],
			"passes": false
		},
		{
			"id": "SP-003",
			"category": "Infrastructure",
			"description": "Returned DO class handles RPC requests via fetch() using Effect RPC",
			"stepsToVerify": [
				"fetch() method converts Request via HttpServerRequest.fromWeb()",
				"RpcServer.toHttpApp() processes the request",
				"Response returned via HttpServerResponse.toWeb()"
			],
			"passes": false
		},
		{
			"id": "SP-004",
			"category": "Infrastructure",
			"description": "Returned DO class runs migrations on construction",
			"stepsToVerify": [
				"Migrations run inside blockConcurrencyWhile()",
				"SqliteMigrator.run() executes with provided migrations",
				"No requests processed until migrations complete"
			],
			"passes": false
		},
		{
			"id": "SP-005",
			"category": "Infrastructure",
			"description": "Handlers receive SqlClient.SqlClient service for database access",
			"stepsToVerify": [
				"Handler can yield* SqlClient.SqlClient",
				"Template literal queries execute successfully",
				"Query results are returned correctly"
			],
			"passes": false
		},
		{
			"id": "SP-006",
			"category": "Infrastructure",
			"description": "Handlers receive DurableObjectEnv and DurableObjectCtx services",
			"stepsToVerify": [
				"DurableObjectEnv service tag exists in services.ts",
				"DurableObjectCtx service tag exists in services.ts",
				"Handler can yield* DurableObjectEnv to access env",
				"Handler can yield* DurableObjectCtx to access ctx"
			],
			"passes": true
		},
		{
			"id": "SP-007",
			"category": "Library Migration",
			"description": "Library DO uses Spellbook.make() pattern",
			"stepsToVerify": [
				"Library.ts imports Spellbook module",
				"Library.ts calls Spellbook.make() with config",
				"Library.ts is approximately 5 lines of code"
			],
			"passes": false
		},
		{
			"id": "SP-008",
			"category": "Library Migration",
			"description": "All Library handlers extracted as pure Effect functions",
			"stepsToVerify": [
				"handlers.ts exists with all handler functions",
				"No handler uses `this` keyword",
				"All handlers return Effect types",
				"Handlers: getStory, listStories, listStoriesByTag, createStory, updateStory, deleteStory, listTags, createTag, updateTag, deleteTag, getTagsForStory, setStoryTags, fetchUrlMetadata"
			],
			"passes": false
		},
		{
			"id": "SP-009",
			"category": "Library Migration",
			"description": "Library Drizzle replaced with @effect/sql-sqlite-do",
			"stepsToVerify": [
				"No drizzle-orm imports in Library feature files",
				"migrations.ts uses Migrator.fromRecord()",
				"Queries use SqlClient template literals",
				"Same database schema preserved"
			],
			"passes": false
		},
		{
			"id": "SP-010",
			"category": "Library Migration",
			"description": "LibraryRpcs contract unchanged",
			"stepsToVerify": [
				"@kampus/library rpc.ts not modified",
				"All existing RPC methods still work",
				"Frontend RPC client works without changes"
			],
			"passes": false
		},
		{
			"id": "SP-011",
			"category": "WebPageParser Migration",
			"description": "WebPageParser DO uses Spellbook.make() pattern",
			"stepsToVerify": [
				"WebPageParser.ts imports Spellbook module",
				"WebPageParser.ts calls Spellbook.make() with config",
				"WebPageParser.ts is approximately 5 lines of code"
			],
			"passes": false
		},
		{
			"id": "SP-012",
			"category": "WebPageParser Migration",
			"description": "WebPageParser converted from DO-RPC to Effect RPC",
			"stepsToVerify": [
				"No direct method calls (stub.init, stub.getMetadata)",
				"Uses fetch() handler with RpcServer",
				"Callers use Effect RPC client"
			],
			"passes": false
		},
		{
			"id": "SP-013",
			"category": "WebPageParser Migration",
			"description": "New @kampus/web-page-parser package created",
			"stepsToVerify": [
				"packages/web-page-parser/ directory exists",
				"package.json has correct name and dependencies",
				"Exports WebPageParserRpcs from rpc.ts",
				"Exports PageMetadata from schema.ts",
				"Package builds without errors"
			],
			"passes": false
		},
		{
			"id": "SP-014",
			"category": "WebPageParser Migration",
			"description": "WebPageParser Drizzle replaced with @effect/sql-sqlite-do",
			"stepsToVerify": [
				"No drizzle-orm imports in WebPageParser feature files",
				"migrations.ts uses Migrator.fromRecord()",
				"Queries use SqlClient template literals"
			],
			"passes": false
		},
		{
			"id": "SP-015",
			"category": "Caller Updates",
			"description": "GraphQL resolver updated for WebPageParser RPC",
			"stepsToVerify": [
				"apps/worker/src/graphql/schema.ts uses RPC client",
				"fetchUrlMetadata query still works",
				"No direct stub.method() calls"
			],
			"passes": false
		},
		{
			"id": "SP-016",
			"category": "Caller Updates",
			"description": "Library DO-to-DO call updated for WebPageParser RPC",
			"stepsToVerify": [
				"Library handlers.ts uses RPC client for WebPageParser",
				"fetchUrlMetadata handler works correctly",
				"No direct stub.method() calls"
			],
			"passes": false
		},
		{
			"id": "SP-017",
			"category": "Code Quality",
			"description": "Library.ts reduced from ~600 lines to ~5 lines",
			"stepsToVerify": [
				"Run: wc -l apps/worker/src/features/library/Library.ts",
				"Result is less than 10 lines"
			],
			"passes": false
		},
		{
			"id": "SP-018",
			"category": "Code Quality",
			"description": "WebPageParser.ts reduced from ~78 lines to ~5 lines",
			"stepsToVerify": [
				"Run: wc -l apps/worker/src/features/web-page-parser/WebPageParser.ts",
				"Result is less than 10 lines"
			],
			"passes": false
		},
		{
			"id": "SP-019",
			"category": "Code Quality",
			"description": "Handlers testable without DO instantiation",
			"stepsToVerify": [
				"Handler functions exported from handlers.ts",
				"Handlers can be imported in test files",
				"Handlers can run with mock SqlClient layer"
			],
			"passes": false
		},
		{
			"id": "SP-020",
			"category": "Testing",
			"description": "Unit tests exist for Library handlers using mock SqlClient",
			"stepsToVerify": [
				"apps/worker/test/library-handlers.spec.ts exists",
				"Tests use mock SqlClient layer",
				"Tests cover: getStory null case, getStory with tags, createStory URL validation"
			],
			"passes": false
		},
		{
			"id": "SP-021",
			"category": "Testing",
			"description": "Unit tests exist for WebPageParser handlers",
			"stepsToVerify": [
				"apps/worker/test/web-page-parser-handlers.spec.ts exists",
				"Tests use mock SqlClient layer",
				"Tests cover: getMetadata cached, getMetadata fetch"
			],
			"passes": false
		},
		{
			"id": "SP-022",
			"category": "Testing",
			"description": "Existing integration tests still pass",
			"stepsToVerify": [
				"Run: pnpm --filter worker run test",
				"All tests pass",
				"No test modifications required for existing tests"
			],
			"passes": false
		},
		{
			"id": "SP-023",
			"category": "Compatibility",
			"description": "Type check passes",
			"stepsToVerify": ["Run: pnpm --filter worker exec tsc --noEmit", "No type errors"],
			"passes": false
		},
		{
			"id": "SP-024",
			"category": "Compatibility",
			"description": "Library UI functionality works",
			"stepsToVerify": [
				"Start dev servers",
				"Navigate to library page",
				"Create a story with URL",
				"Add tags to story",
				"Delete story",
				"All operations succeed"
			],
			"passes": false
		},
		{
			"id": "SP-025",
			"category": "Compatibility",
			"description": "Fetch-title UI functionality works",
			"stepsToVerify": [
				"Start dev servers",
				"Create new story form",
				"Enter URL and trigger fetch",
				"Title auto-populates from URL metadata"
			],
			"passes": false
		},
		{
			"id": "SP-026",
			"category": "Dependencies",
			"description": "@effect/sql added to worker package",
			"stepsToVerify": ["Check apps/worker/package.json dependencies", "@effect/sql is listed"],
			"passes": true
		},
		{
			"id": "SP-027",
			"category": "Dependencies",
			"description": "@effect/sql-sqlite-do added to worker package",
			"stepsToVerify": [
				"Check apps/worker/package.json dependencies",
				"@effect/sql-sqlite-do is listed"
			],
			"passes": true
		},
		{
			"id": "SP-028",
			"category": "Cleanup",
			"description": "Library Drizzle folder removed",
			"stepsToVerify": ["apps/worker/src/features/library/drizzle/ does not exist"],
			"passes": false
		},
		{
			"id": "SP-029",
			"category": "Cleanup",
			"description": "WebPageParser Drizzle folder removed",
			"stepsToVerify": ["apps/worker/src/features/web-page-parser/drizzle/ does not exist"],
			"passes": false
		},
		{
			"id": "SP-030",
			"category": "Documentation",
			"description": "CLAUDE.md updated with Spellbook patterns",
			"stepsToVerify": [
				"CLAUDE.md mentions Spellbook.make() pattern",
				"Backend Features section updated",
				"@effect/sql patterns documented"
			],
			"passes": false
		}
	],
	"summary": {
		"total": 30,
		"passed": 4,
		"categories": {
			"Infrastructure": 6,
			"Library Migration": 4,
			"WebPageParser Migration": 4,
			"Caller Updates": 2,
			"Code Quality": 3,
			"Testing": 3,
			"Compatibility": 3,
			"Dependencies": 2,
			"Cleanup": 2,
			"Documentation": 1
		}
	}
}
