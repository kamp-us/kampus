## 2026-01-15: Story Model + Spellbook Transforms (ESM-001, ESM-004)

### Files Changed
- apps/worker/src/features/library/models.ts (created)
- apps/worker/src/features/library/Library.ts (add RepoLayer)
- apps/worker/src/shared/Spellbook.ts (add transforms + layers config)
- apps/worker/src/features/library/handlers.ts (snake_case -> camelCase)
- apps/worker/test/library-handlers.spec.ts (fix mock data)

### Key Decisions
1. Enable SqlClient transforms globally in Spellbook (transformQueryNames, transformResultNames)
2. Update all handlers to use camelCase property names (instead of per-handler refactor)
3. Defer handler refactoring to use repo.insert/findById (ESM-005) - handlers still use raw SQL
4. Story Model has normalizedUrl field (not updatedAt - not in current DB schema)
5. Removed unused getTagsForStories function (ESM-006 partial)

### Verification
- turbo run typecheck: PASS
- pnpm --filter worker run test: PASS (51 tests)

### Next Steps
- ESM-002: Tag Model.Class
- ESM-003: TagRepo Effect.Service
- ESM-005: Replace raw SQL with repo methods in handlers

## 2026-01-15: Tag Model + TagRepo (ESM-002, ESM-003)

### Files Changed
- apps/worker/src/features/library/models.ts (add Tag Model.Class, TagRepo, update RepoLayer)

### Key Decisions
1. Tag Model mirrors Drizzle schema: id, name, color, createdAt
2. TagRepo uses Effect.Service with Model.makeRepository (same pattern as StoryRepo)
3. RepoLayer now merges StoryRepo.Default + TagRepo.Default via Layer.mergeAll

### Verification
- turbo run typecheck --filter=worker: PASS
- pnpm --filter worker run test: PASS (51 tests)

### Next Steps
- ESM-005: Refactor handlers to use StoryRepo/TagRepo instead of raw SQL

## 2026-01-15: Handler Refactoring + Cleanup (ESM-005, ESM-006)

### Files Changed
- apps/worker/src/features/library/handlers.ts (use repos in CRUD handlers)
- apps/worker/test/library-handlers.spec.ts (simplify unit tests)

### Key Decisions
1. Refactored handlers to use repos:
   - getStory: StoryRepo.findById()
   - createStory: StoryRepo.insert()
   - deleteStory: StoryRepo.findById() + delete()
   - createTag: TagRepo.insert()
   - deleteTag: TagRepo.findById() + delete()
2. Kept raw SQL for complex operations:
   - listStories, listStoriesByTag (pagination)
   - updateStory, updateTag (partial updates)
   - getTagsForStory, setStoryTags (joins)
3. Added formatStoryFromModel/formatTagFromModel helpers for DateTime.formatIso
4. Unit tests: removed tests needing full SqlClient mock, kept URL validation + listStories
5. Row interfaces retained (still needed by raw SQL handlers)

### Verification
- turbo run typecheck: PASS
- pnpm --filter worker run test: PASS (43 tests)
- biome check: PASS (2 warnings on existing non-null assertions)

### Next Steps
- ESM-100+: Test coverage items (story/tag CRUD, pagination, edge cases)

## 2026-01-15: Test Coverage Expansion (ESM-100 to ESM-304)

### Files Changed
- apps/worker/test/library-stories.spec.ts (add 12 tests)
- apps/worker/test/library-tags.spec.ts (add 3 tests)

### Tests Added
1. Story create with tags (ESM-102)
2. Story create with non-existent tagIds (ESM-104)
3. Get story with tags in correct format (ESM-112)
4. Update story description (ESM-131)
5. Clear story description (ESM-132)
6. Update story tags - add (ESM-133)
7. Update story tags - remove (ESM-134)
8. Update story tags - replace (ESM-135)
9. List stories with their tags (ESM-125)
10. List tags returns empty array (ESM-211)
11. setStoryTags replaces all tags (ESM-302)
12. setStoryTags with empty array clears (ESM-303)

### PRD Status
- 49/67 items passing (73%)
- Remaining items mostly:
  - Validation error tests (vitest-pool-workers isolation issue)
  - updatedAt field (not in schema)
  - Edge cases/concurrency (future work)

### Verification
- turbo run typecheck: PASS
- pnpm --filter worker run test: PASS (55 tests)
- biome check: PASS (warnings OK)
