# GraphQL + Relay M1 Progress

## 2026-01-16: getBatchStory RPC (FR-1.1)

**Files:**
- packages/library/src/rpc.ts - added getBatchStory RPC definition
- apps/worker/src/features/library/handlers.ts - added getBatchStory handler

**Implementation:**
- RPC: `getBatchStory({ids: string[]})` returns `(Story | null)[]`
- Handler uses `inArray` query, builds Map for O(1) lookup
- Returns nulls for missing stories, preserves input order
- Early return for empty array (no DB call)

**Verified:**
- `pnpm --filter worker run typecheck` passes
- `pnpm --filter worker run test` passes (68 tests)

## 2026-01-16: getBatchTag RPC (FR-1.2, FR-1.3)

**Files:**
- packages/library/src/rpc.ts - added getBatchTag RPC definition
- apps/worker/src/features/library/handlers.ts - added getBatchTag handler

**Implementation:**
- RPC: `getBatchTag({ids: string[]})` returns `(Tag | null)[]`
- Handler uses `inArray` query with story count subquery
- Returns nulls for missing tags, preserves input order
- Early return for empty array (no DB call) - verifies FR-1.3

**Verified:**
- `turbo run typecheck` passes
- `pnpm --filter worker run test` passes (68 tests)

## 2026-01-16: Spellcaster RPC Client Factory (FR-2.1 - FR-2.5)

**Files:**
- apps/worker/src/shared/Spellcaster.ts - NEW: generic RPC client factory for DO stubs
- apps/worker/src/graphql/resolvers/LibraryClient.ts - NEW: LibraryClient service + layer factory
- apps/worker/src/graphql/resolvers/index.ts - NEW: barrel export

**Implementation:**
- `Spellcaster.make({rpcs, stub})` returns `Effect<RpcClient<R>>`
- Uses Effect RPC protocol: `RpcClient.layerProtocolHttp` + `RpcSerialization.layerJson`
- Custom fetch wraps DO stub.fetch() for DO-to-DO communication
- `LibraryClient` Context.Tag provides typed RPC client in Effect programs
- `LibraryClient.layer(env, userId)` static method creates per-request layer routing to user's DO

**Design Decisions:**
- Used `Fetchable` interface instead of importing `@cloudflare/workers-types` (not in deps)
- Used `RpcClient.FromGroup<typeof LibraryRpcs>` for correct type extraction from RpcGroup

**Verified:**
- `turbo run typecheck --filter=worker` passes
- `pnpm --filter worker run test` passes (68 tests)

## 2026-01-16: Effect RequestResolver + Batched Loaders (FR-3.1 - FR-3.7)

**Files:**
- apps/worker/src/graphql/requests.ts - NEW: Effect Request types (GetStory, GetTag)
- apps/worker/src/graphql/resolvers/StoryResolver.ts - NEW: batched resolver + loadStory helper
- apps/worker/src/graphql/resolvers/TagResolver.ts - NEW: batched resolver + loadTag helper
- apps/worker/src/graphql/resolvers/index.ts - added exports for resolvers/helpers
- apps/worker/test/request-resolver.spec.ts - NEW: tests for batching behavior

**Implementation:**
- `GetStory`/`GetTag` interfaces extend `Request.Request<T | null, never>` with tagged constructors
- `StoryResolver`/`TagResolver` use `RequestResolver.makeBatched` with `contextFromServices(LibraryClient)`
- Resolvers call `getBatchStory`/`getBatchTag` RPC and distribute results to individual requests
- `loadStory(id)`/`loadTag(id)` helpers wrap `Effect.request` for ergonomic usage in GraphQL resolvers

**IMPORTANT: Batching requires explicit opt-in**
- Effect does NOT batch by default - must use `batching: true` option
- GraphQL resolvers must use `Effect.all([...], {concurrency: "unbounded", batching: true})`
- Or wrap with `Effect.withRequestBatching(true)` at the runtime level

**Verified (with tests):**
- `turbo run typecheck --filter=worker` passes
- `pnpm --filter worker run test` passes (74 tests)
- Test: parallel loadStory calls batch into single getBatchStory RPC
- Test: parallel loadTag calls batch into single getBatchTag RPC
- Test: sequential calls do NOT batch (expected)
- Test: null returned for missing items, order preserved

## 2026-01-16: PRD Audit

**Reset all FR-1.x, FR-2.x, FR-3.x to passes: false**

Reason: items were marked passing without proper test coverage.

**Status:**
- FR-1.x: needs integration tests (getBatchStory/getBatchTag handlers)
- FR-2.x: verified by typecheck only, no runtime tests
- FR-3.x: has test coverage in request-resolver.spec.ts

**Next:** Write integration tests for FR-1.x, then mark items as passing

## 2026-01-17: FR-1.x, FR-2.x, FR-3.x Complete

**Files:**
- apps/worker/test/rpc-test-client.ts - added getBatchStory/getBatchTag methods
- apps/worker/test/library-stories.spec.ts - added "Batch Story Operations (FR-1.1)" tests
- apps/worker/test/library-tags.spec.ts - added "Batch Tag Operations (FR-1.2, FR-1.3)" tests

**Tests Added:**
- getBatchStory returns stories in input order
- getBatchStory returns null for missing stories at correct index
- getBatchStory returns stories with their tags
- getBatchStory with empty array returns empty array
- getBatchTag returns tags in input order
- getBatchTag returns null for missing tags at correct index
- getBatchTag includes storyCount for each tag
- getBatchTag with empty array returns empty array

**Verified:**
- `turbo run typecheck --filter=worker` passes
- `pnpm --filter worker run test` passes (82 tests)

**PRD Status:**
- FR-1.1, FR-1.2, FR-1.3: passes=true (integration tests)
- FR-2.1 - FR-2.5: passes=true (typecheck + code inspection)
- FR-3.1 - FR-3.7: passes=true (request-resolver.spec.ts)

## 2026-01-17: GraphQL Schema Types + Queries + Mutations (FR-4.x, FR-5.x, FR-6.x, FR-9.1)

**Files:**
- apps/worker/src/graphql/connections.ts - NEW: PageInfoType, createConnectionTypes(), toConnection()
- apps/worker/src/graphql/schema.ts - extended with Library types, queries, mutations
- apps/worker/src/graphql/runtime.ts - added LibraryClient layer to per-request runtime

**Implementation:**

Schema Types (FR-4.x):
- `TagType`: id, name, color
- `StoryType`: id, url, title, description, createdAt, tags (implements Node)
- `WebPageType`: url, title, description, error
- `LibraryType`: namespace with story, stories, tags, webPage fields
- `PageInfoType`: Relay-spec pagination (hasNextPage, hasPreviousPage, startCursor, endCursor)
- `StoryEdgeType`, `StoryConnectionType`: via createConnectionTypes() factory
- `NodeInterface`: resolveType by field detection (url → Story, color → Tag)

Queries (FR-5.x):
- `library` - requires Auth.required, returns Library namespace
- `library.story(id)` - uses loadStory() for batched resolution
- `library.stories(first, after, tagId)` - direct RPC to listStories/listStoriesByTag + toConnection()
- `library.tags` - direct RPC to listTags()
- `library.webPage(url)` - WebPageParser DO integration
- `node(id)` - Relay refetch support (story_, tag_ prefix detection)

Mutations (FR-6.x):
- `createStory(input)` → CreateStoryPayload {story, storyEdge}
- `updateStory(input)` → UpdateStoryPayload {story}
- `deleteStory(input)` → DeleteStoryPayload {deletedStoryId}
- `createTag(input)` → CreateTagPayload {tag}

Runtime (FR-9.1):
- LibraryClient.layer added to GraphQLRuntime when user authenticated

**Design Decisions:**
- Tags embedded in Story response (no batched resolution needed - already in RPC response)
- Node interface resolves by field presence, not ID prefix
- toConnection() accepts readonly arrays to match Effect Schema output

**Verified:**
- `turbo run typecheck` passes
- `pnpm --filter worker run test` passes (82 tests)

**PRD Status:**
- FR-4.1 - FR-4.10: passes=true (schema types)
- FR-5.1 - FR-5.4: passes=true (queries)
- FR-6.1 - FR-6.5: passes=true (mutations)
- FR-9.1: passes=true (runtime)
- NFR-1.2, NFR-2.3, NFR-4.1, NFR-4.2: passes=true
- TEST-1, TEST-2: passes=true
